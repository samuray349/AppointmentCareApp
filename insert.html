<!DOCTYPE html>
<html lang="pt">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <title>Nova Consulta - AppointmentCare</title>
    <style>
        body { font-family: 'Inter', sans-serif; }
    </style>
</head>

<body class="bg-gray-50">

    <header class="bg-white shadow-md sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-20">
                <a href="index.html" class="text-2xl font-extrabold text-blue-600 tracking-tight flex items-center">
                    <svg class="w-8 h-8 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8h16M4 16h16M10 4h4M8 20h8M6 12h12"></path>
                    </svg>
                    Appointment<span class="text-blue-400">Care</span>
                </a>
                <nav class="hidden md:flex space-x-8">
                    <a href="/dashboard" class="text-gray-600 hover:text-blue-600 font-medium">Voltar ao Dashboard</a>
                </nav>
            </div>
        </div>
    </header>

    <main class="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
        
        <div class="mb-8 flex items-center justify-between">
            <div>
                <h1 class="text-3xl font-extrabold text-gray-900">Nova Consulta</h1>
                <p class="text-gray-600 mt-1">Preencha os dados para agendar.</p>
            </div>
            <a href="/dashboard" class="text-sm text-blue-600 hover:underline">← Cancelar e voltar</a>
        </div>

        <div class="bg-white rounded-xl shadow-lg p-8">
            
            <div id="alertBox" class="hidden mb-6 p-4 rounded-lg"></div>

            <form id="createForm" class="space-y-6">
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    
                    <div class="col-span-2">
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Paciente</label>
                        <select id="pacient_id" required
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition bg-white">
                            <option value="">A carregar pacientes...</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Especialidade</label>
                        <select id="speciality_id" required onchange="filterDoctors()"
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition bg-white">
                            <option value="">Selecione a especialidade</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Médico</label>
                        <select id="doctor_id" required disabled
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition bg-gray-100 disabled:cursor-not-allowed">
                            <option value="">Selecione primeiro a especialidade</option>
                        </select>
                    </div>

                    <div class="col-span-2">
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Data e Hora da Consulta</label>
                        <input type="datetime-local" id="appointment_date" required
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition">
                        <p class="text-xs text-gray-500 mt-1">O sistema verificará a disponibilidade automaticamente.</p>
                    </div>
                </div>

                <div class="flex items-center space-x-3 pt-2">
                    <input type="checkbox" id="sms_sent" class="w-5 h-5 text-blue-600 rounded border-gray-300 focus:ring-blue-500">
                    <label for="sms_sent" class="text-sm text-gray-700">Enviar notificação por SMS ao paciente</label>
                </div>

                <div class="pt-6 border-t border-gray-100 flex justify-end">
                    <button type="submit" 
                        class="px-8 py-3 bg-blue-600 text-white font-bold rounded-xl shadow-md hover:bg-blue-700 transform hover:-translate-y-0.5 transition duration-200">
                        Agendar Consulta
                    </button>
                </div>
            </form>
        </div>
    </main>

    <script>
        // Dados em memória
        let allDoctors = [];
        let allPacients = [];
        let existingAppointments = [];

        // Inicialização
        document.addEventListener('DOMContentLoaded', async () => {
            await Promise.all([
                loadPacients(),
                loadSpecialities(),
                loadDoctors(),
                loadExistingAppointments() // Necessário para verificação de conflitos
            ]);
        });

        // --- Funções de Carregamento de Dados ---

        async function loadPacients() {
            try {
                const res = await fetch('http://localhost:3000/api/pacients');
                const data = await res.json();
                allPacients = data.data || data; // Adaptação conforme estrutura da API
                
                const select = document.getElementById('pacient_id');
                select.innerHTML = '<option value="">Selecione um paciente</option>' + 
                    allPacients.map(p => `<option value="${p.id_pacient}">${p.name}</option>`).join('');
            } catch (e) { console.error('Erro pacientes', e); }
        }

        async function loadSpecialities() {
            try {
                const res = await fetch('http://localhost:3000/api/specialities');
                const data = await res.json();
                const list = data.data || data;
                
                const select = document.getElementById('speciality_id');
                select.innerHTML = '<option value="">Selecione a especialidade</option>' + 
                    list.map(s => `<option value="${s.id_speciality}">${s.name}</option>`).join('');
            } catch (e) { console.error('Erro especialidades', e); }
        }

        async function loadDoctors() {
            try {
                const res = await fetch('http://localhost:3000/api/doctors');
                const data = await res.json();
                allDoctors = data.data || data;
            } catch (e) { console.error('Erro médicos', e); }
        }

        async function loadExistingAppointments() {
            try {
                const res = await fetch('http://localhost:3000/api/appointments');
                existingAppointments = await res.json();
            } catch (e) { console.error('Erro consultas', e); }
        }

        // --- Lógica de Interação ---

        function filterDoctors() {
            const specialityId = document.getElementById('speciality_id').value;
            const doctorSelect = document.getElementById('doctor_id');
            
            doctorSelect.innerHTML = '<option value="">Selecione um médico</option>';
            doctorSelect.disabled = !specialityId;
            
            if (specialityId) {
                // Filtra médicos pela especialidade selecionada
                const filtered = allDoctors.filter(d => d.speciality_id == specialityId);
                
                if (filtered.length > 0) {
                    doctorSelect.innerHTML += filtered.map(d => `<option value="${d.id_doctor}">${d.name}</option>`).join('');
                    doctorSelect.classList.remove('bg-gray-100');
                    doctorSelect.classList.add('bg-white');
                } else {
                    doctorSelect.innerHTML = '<option value="">Nenhum médico disponível nesta área</option>';
                }
            } else {
                doctorSelect.classList.add('bg-gray-100');
            }
        }

        // --- Lógica de Validação e Envio ---

        document.getElementById('createForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const alertBox = document.getElementById('alertBox');
            alertBox.classList.add('hidden');

            // 1. Recolha de Dados
            const pacientId = document.getElementById('pacient_id').value;
            const doctorId = document.getElementById('doctor_id').value;
            const appointmentDate = document.getElementById('appointment_date').value;
            const smsSent = document.getElementById('sms_sent').checked;

            if (!appointmentDate) {
                showAlert('Por favor, selecione uma data válida.', 'error');
                return;
            }

            // 2. Verificação de Conflitos (Client-Side)
            // Nota: O servidor já verifica médicos, mas adicionamos aqui verificação extra para Pacientes
            const conflict = checkConflicts(pacientId, doctorId, appointmentDate);
            if (conflict) {
                showAlert(conflict, 'error');
                return;
            }

            // 3. Envio para o Servidor
            const payload = {
                pacient_id: parseInt(pacientId),
                doctor_id: parseInt(doctorId),
                scheduled_date: new Date().toISOString().slice(0, 19).replace('T', ' '),
                appointment_date: new Date(appointmentDate).toISOString().slice(0, 19).replace('T', ' '), // Data de criação (hoje)
                status: 'scheduled',
                sms_sent: smsSent
            };

            try {
                const res = await fetch('http://localhost:3000/api/appointments', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const json = await res.json();

                if (res.ok) {
                    showAlert('Consulta agendada com sucesso! Redirecionando...', 'success');
                    setTimeout(() => window.location.href = '/dashboard', 1500);
                } else {
                    // Tratar erro do servidor (ex: conflito de médico detectado pelo backend)
                    showAlert(json.message || 'Erro ao agendar consulta.', 'error');
                }
            } catch (err) {
                showAlert('Erro de conexão com o servidor.', 'error');
            }
        });

        function checkConflicts(pacientId, doctorId, newDateStr) {
            const newDate = new Date(newDateStr);
            const selectedPacient = allPacients.find(p => p.id_pacient == pacientId);
            const selectedDoctor = allDoctors.find(d => d.id_doctor == doctorId);

            // Intervalo de segurança (20 minutos)
            const margin = 20 * 60 * 1000; 

            for (const apt of existingAppointments) {
                // Ignorar canceladas
                if (apt.status === 'cancelled') continue;
                if (!apt.appointment_date) continue;

                const aptDate = new Date(apt.appointment_date);
                const diff = Math.abs(aptDate - newDate);

                // Se a diferença for menor que 20 minutos
                if (diff < margin) {
                    
                    // Verifica conflito de PACIENTE (usando o nome, pois o GET /appointments não devolve IDs)
                    // Nota: Idealmente o backend deveria devolver o ID, mas usamos o nome como fallback
                    if (selectedPacient && apt.pacient_name === selectedPacient.name) {
                        return `Conflito: O paciente ${selectedPacient.name} já tem uma consulta às ${aptDate.toLocaleTimeString().slice(0,5)}.`;
                    }

                    // Verifica conflito de MÉDICO (apenas redundância visual, o backend também valida)
                    if (selectedDoctor && apt.doctor_name === selectedDoctor.name) {
                        return `Conflito: O Dr(a). ${selectedDoctor.name} já tem uma consulta marcada perto desse horário.`;
                    }
                }
            }
            return null; // Sem conflitos
        }

        function showAlert(msg, type) {
            const box = document.getElementById('alertBox');
            box.textContent = msg;
            box.classList.remove('hidden', 'bg-red-100', 'text-red-700', 'bg-green-100', 'text-green-700');
            
            if (type === 'error') {
                box.classList.add('bg-red-100', 'text-red-700', 'border', 'border-red-200');
            } else {
                box.classList.add('bg-green-100', 'text-green-700', 'border', 'border-green-200');
            }
        }
    </script>
</body>
</html>